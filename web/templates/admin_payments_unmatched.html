{{ define "content" }}
<style>
/* Page-specific styles for admin_payments_unmatched ‚Äî shared styles are in /static/css/admin.css */

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            margin-bottom: 10px;
            color: #333;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .category-section {
            margin-bottom: 40px;
        }

        .category-section details {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }

        .category-section summary {
            cursor: pointer;
            user-select: none;
            list-style: none;
        }

        .category-section summary::-webkit-details-marker {
            display: none;
        }

        .category-header {
            background: #f9fafb;
            padding: 12px 15px;
            border-left: 4px solid #2563eb;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .category-section summary:hover .category-header {
            background: #f3f4f6;
        }

        .category-section details[open] .category-header {
            margin-bottom: 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .category-content {
            padding: 0;
        }

        .category-header.empty-vs {
            border-left-color: #6b7280;
        }

        .category-header.invalid-vs {
            border-left-color: #f59e0b;
        }

        .category-header.user-not-found {
            border-left-color: #ef4444;
        }

        .category-header.sync-bug {
            border-left-color: #8b5cf6;
        }

        .category-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            flex: 1;
        }

        .category-count {
            background: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        .collapse-indicator {
            font-size: 12px;
            color: #9ca3af;
            margin-left: auto;
            transition: transform 0.2s;
        }

        details[open] .collapse-indicator {
            transform: rotate(180deg);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .amount {
            font-weight: 600;
            color: #059669;
        }

        .date {
            color: #6b7280;
            font-size: 13px;
        }

        .vs {
            font-family: 'Courier New', monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }

        .account {
            font-size: 13px;
        }

        .reason {
            font-size: 13px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .help-text {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }

        .help-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e40af;
        }

        .help-list {
            margin-left: 20px;
            color: #1e40af;
        }

        .help-list li {
            margin-bottom: 5px;
        }

        .payment-info {
            background: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #e5e7eb;
        }

        .payment-info p {
            margin: 8px 0;
            color: #374151;
        }

        .assign-form h3 {
            margin-bottom: 15px;
            color: #111827;
        }

        .user-item:hover {
            background: #f3f4f6 !important;
        }
    </style>
    <div class="container">
        <div style="margin-bottom: 20px;">
            <h1 style="margin: 0;">üí∞ Finanƒçn√≠ p≈ôehled - Nesp√°rovan√© platby</h1>
            <p class="subtitle" style="margin: 5px 0 0 0;">P≈ô√≠choz√≠ platby, kter√© se nepoda≈ôilo automaticky p≈ôi≈ôadit k u≈æivateli</p>
        </div>

        {{if eq .TotalCount 0}}
        <div class="empty-state">
            <div class="empty-state-icon">‚úì</div>
            <h3>≈Ω√°dn√© nesp√°rovan√© platby</h3>
            <p>V≈°echny p≈ô√≠choz√≠ platby jsou spr√°vnƒõ p≈ôi≈ôazeny k u≈æivatel≈Øm.</p>
        </div>
        {{else}}

        <!-- Empty VS -->
        {{if gt .CountEmptyVS 0}}
        <div class="category-section">
            <details open>
                <summary>
                    <div class="category-header empty-vs">
                        <span class="category-title">üìù Pr√°zdn√Ω variabiln√≠ symbol</span>
                        <span class="category-count">{{.CountEmptyVS}}</span>
                        <span class="collapse-indicator">‚ñº</span>
                    </div>
                </summary>
                <div class="category-content">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Datum</th>
                        <th>ƒå√°stka</th>
                        <th>Odes√≠latel</th>
                        <th>Pozn√°mka</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .UnmatchedList}}
                    {{if eq .Category "empty_vs"}}
                    <tr>
                        <td>{{.Payment.ID}}</td>
                        <td class="date">{{.Payment.Date.Format "02.01.2006"}}</td>
                        <td class="amount incoming">+{{.Payment.Amount}} Kƒç</td>
                        <td class="account">{{.Payment.RemoteAccount}}</td>
                        <td class="reason">Bez VS - manu√°ln√≠ p≈ôi≈ôazen√≠ nutn√©</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="managePayment({{.Payment.ID}}, '{{.Payment.Amount}}', '{{.Payment.Date.Format "02.01.2006"}}', '{{.Payment.RemoteAccount}}', '{{.Payment.Identification}}', '', '')">
                                Spr√°va
                            </button>
                        </td>
                    </tr>
                    {{end}}
                    {{end}}
                </tbody>
            </table>
                </div>
            </details>
        </div>
        {{end}}

        <!-- User not found -->
        {{if gt .CountUserNotFound 0}}
        <div class="category-section">
            <details>
                <summary>
                    <div class="category-header user-not-found">
                        <span class="category-title">‚ùå U≈æivatel nenalezen</span>
                        <span class="category-count">{{.CountUserNotFound}}</span>
                        <span class="collapse-indicator">‚ñº</span>
                    </div>
                </summary>
                <div class="category-content">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Datum</th>
                        <th>ƒå√°stka</th>
                        <th>VS / payments_id</th>
                        <th>Odes√≠latel</th>
                        <th>Pozn√°mka</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .UnmatchedList}}
                    {{if eq .Category "user_not_found"}}
                    <tr>
                        <td>{{.Payment.ID}}</td>
                        <td class="date">{{.Payment.Date.Format "02.01.2006"}}</td>
                        <td class="amount incoming">+{{.Payment.Amount}} Kƒç</td>
                        <td><span class="vs">{{.Payment.Identification}}</span></td>
                        <td class="account">{{.Payment.RemoteAccount}}</td>
                        <td class="reason">U≈æivatel s payments_id '{{.Payment.Identification}}' neexistuje</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="managePayment({{.Payment.ID}}, '{{.Payment.Amount}}', '{{.Payment.Date.Format "02.01.2006"}}', '{{.Payment.RemoteAccount}}', '{{.Payment.Identification}}', '', '')">
                                Spr√°va
                            </button>
                        </td>
                    </tr>
                    {{end}}
                    {{end}}
                </tbody>
            </table>
                </div>
            </details>
        </div>
        {{end}}

        <!-- Sync bug -->
        {{if gt .CountSyncBug 0}}
        <div class="category-section">
            <details>
                <summary>
                    <div class="category-header sync-bug">
                        <span class="category-title">üêõ Mo≈æn√Ω sync probl√©m</span>
                        <span class="category-count">{{.CountSyncBug}}</span>
                        <span class="collapse-indicator">‚ñº</span>
                    </div>
                </summary>
                <div class="category-content">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Datum</th>
                        <th>ƒå√°stka</th>
                        <th>VS / payments_id</th>
                        <th>Odes√≠latel</th>
                        <th>Pozn√°mka</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .UnmatchedList}}
                    {{if eq .Category "sync_bug"}}
                    <tr>
                        <td>{{.Payment.ID}}</td>
                        <td class="date">{{.Payment.Date.Format "02.01.2006"}}</td>
                        <td class="amount incoming">+{{.Payment.Amount}} Kƒç</td>
                        <td><span class="vs">{{.Payment.Identification}}</span></td>
                        <td class="account">{{.Payment.RemoteAccount}}</td>
                        <td class="reason">U≈æivatel s t√≠mto payments_id existuje, ale platba nen√≠ p≈ôi≈ôazena!</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="managePayment({{.Payment.ID}}, '{{.Payment.Amount}}', '{{.Payment.Date.Format "02.01.2006"}}', '{{.Payment.RemoteAccount}}', '{{.Payment.Identification}}', '', '')">
                                Spr√°va
                            </button>
                        </td>
                    </tr>
                    {{end}}
                    {{end}}
                </tbody>
            </table>
                </div>
            </details>
        </div>
        {{end}}

        {{end}}

        <!-- Dismissed/Archived Payments -->
        {{if gt .DismissedCount 0}}
        <div class="category-section" style="margin-top: 40px;">
            <details>
                <summary>
                    <div class="category-header" style="border-left-color: #9ca3af; background: #f3f4f6;">
                        <span class="category-title" style="color: #6b7280;">üóÑÔ∏è Archiv - Vy≈ô√≠zen√© platby (smeti≈°tƒõ dƒõjin)</span>
                        <span class="category-count">{{.DismissedCount}}</span>
                        <span style="font-size: 12px; color: #9ca3af; margin-left: 10px;">{{printf "%.0f" .DismissedTotal}} Kƒç</span>
                        <span class="collapse-indicator">‚ñº</span>
                    </div>
                </summary>
                <div class="category-content">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Datum</th>
                        <th>ƒå√°stka</th>
                        <th>VS</th>
                        <th>Odes√≠latel</th>
                        <th>D≈Øvod archivace</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .DismissedPayments}}
                    <tr style="opacity: 0.7;">
                        <td>{{.ID}}</td>
                        <td class="date">{{.Date.Format "02.01.2006"}}</td>
                        <td class="amount" style="color: #9ca3af;">+{{.Amount}} Kƒç</td>
                        <td>{{if .Identification}}<span class="vs">{{.Identification}}</span>{{else}}-{{end}}</td>
                        <td class="account">{{.RemoteAccount}}</td>
                        <td class="reason" style="font-size: 12px;">{{if .StaffComment.Valid}}{{.StaffComment.String}}{{else}}-{{end}}</td>
                        <td>
                            <button class="btn btn-sm" style="background: #10b981; color: white;" onclick="undismissPayment({{.ID}})">
                                O≈æivit
                            </button>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
                </div>
            </details>
        </div>
        {{end}}

        <!-- Payment Management Modal -->
        <div id="assignmentModal" class="modal" style="display:none;">
            <div class="modal-content" style="width: 700px;">
                <span class="close" onclick="closeAssignmentModal()">&times;</span>
                <h2>Spr√°va platby <span id="modalPaymentId"></span></h2>

                <!-- Basic Info -->
                <div class="payment-info">
                    <p><strong>Datum:</strong> <span id="modalPaymentDate"></span></p>
                    <p><strong>ƒå√°stka:</strong> <span id="modalPaymentAmount"></span></p>
                    <p><strong>Odes√≠latel:</strong> <span id="modalPaymentAccount"></span></p>
                </div>

                <!-- Editable Payment Data -->
                <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin: 20px 0; border: 1px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #111827; font-weight: 600;">Doplnit / upravit informace</h3>

                    <div style="display: grid; gap: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500; color: #374151;">Variabiln√≠ symbol:</label>
                            <input type="text" id="editVS" placeholder="nap≈ô. 108" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500; color: #374151;">Zpr√°va pro p≈ô√≠jemce:</label>
                            <input type="text" id="editMessage" placeholder="nap≈ô. dar na energie" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500; color: #374151;">Koment√°≈ô:</label>
                            <input type="text" id="editComment" placeholder="voliteln√Ω koment√°≈ô" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>

                <!-- Assignment Options -->
                <div style="background: #fff; padding: 15px; border-radius: 6px; margin: 20px 0; border: 1px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #111827; font-weight: 600;">P≈ôi≈ôazen√≠</h3>

                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Assign to User -->
                        <label style="display: flex; align-items: start; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="if(!document.getElementById('assignToUser').checked) this.style.background='white'">
                            <input type="radio" name="assignType" id="assignToUser" value="user" onchange="handleAssignTypeChange('user')" style="margin-top: 3px;">
                            <div style="margin-left: 10px; flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px;">P≈ôi≈ôadit u≈æivateli</div>
                                <div id="userAssignSection" style="display: none; margin-top: 10px;">
                                    <input type="text" id="userSearch" placeholder="Hledat podle emailu, jm√©na nebo ID..." oninput="searchUsers()" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <div id="userList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                                        <div style="padding: 20px; text-align: center; color: #6b7280; font-size: 13px;">
                                            Zadejte text pro vyhled√°n√≠ u≈æivatele
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <!-- Assign to Project -->
                        <label style="display: flex; align-items: start; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="if(!document.getElementById('assignToProject').checked) this.style.background='white'">
                            <input type="radio" name="assignType" id="assignToProject" value="project" onchange="handleAssignTypeChange('project')" style="margin-top: 3px;">
                            <div style="margin-left: 10px; flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px;">P≈ôi≈ôadit projektu / fundraising</div>
                                <div id="projectAssignSection" style="display: none; margin-top: 10px;">
                                    <select id="projectSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Naƒç√≠t√°n√≠ projekt≈Ø...</option>
                                    </select>
                                </div>
                            </div>
                        </label>

                        <!-- Leave Unmatched -->
                        <label style="display: flex; align-items: start; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="if(!document.getElementById('leaveUnmatched').checked) this.style.background='white'">
                            <input type="radio" name="assignType" id="leaveUnmatched" value="unmatched" onchange="handleAssignTypeChange('unmatched')" style="margin-top: 3px;">
                            <div style="margin-left: 10px;">
                                <div style="font-weight: 600; margin-bottom: 5px;">Nechat nesp√°rovan√©</div>
                                <div style="font-size: 13px; color: #6b7280;">Jen ulo≈æit upraven√© √∫daje bez p≈ôi≈ôazen√≠</div>
                            </div>
                        </label>

                        <!-- Dismiss / Ignore -->
                        <label style="display: flex; align-items: start; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s; background: #fef2f2;" onmouseover="this.style.background='#fee2e2'" onmouseout="if(!document.getElementById('dismissPayment').checked) this.style.background='#fef2f2'">
                            <input type="radio" name="assignType" id="dismissPayment" value="dismiss" onchange="handleAssignTypeChange('dismiss')" style="margin-top: 3px;">
                            <div style="margin-left: 10px; flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px; color: #991b1b;">Oznaƒçit jako vy≈ô√≠zeno (ignorovat)</div>
                                <div style="font-size: 13px; color: #6b7280;">Platba zmiz√≠ z tohoto seznamu - nep≈ôi≈ôad√≠ se nikomu</div>
                                <div id="dismissSection" style="display: none; margin-top: 10px;">
                                    <input type="text" id="dismissReason" placeholder="D≈Øvod (nap≈ô. dar, jednor√°zov√° platba, duplicita...)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Admin Comment -->
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Pozn√°mka admin (voliteln√©):</label>
                    <textarea id="staffComment" rows="3" placeholder="Nap≈ô: Platba ovƒõ≈ôena osobnƒõ, dar na energie 2024, opraven√Ω VS, atd." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>

                <!-- Actions -->
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeAssignmentModal()" class="btn btn-secondary">Zru≈°it</button>
                    <button id="confirmAssignBtn" onclick="confirmAssignment()" class="btn btn-primary">Ulo≈æit zmƒõny</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedUserId = null;
        let selectedProjectId = null;
        let currentPaymentId = null;

        function managePayment(paymentId, amount, date, account, vs, message, comment) {
            currentPaymentId = paymentId;
            selectedUserId = null;
            selectedProjectId = null;

            // Set basic info
            document.getElementById('modalPaymentId').textContent = '#' + paymentId;
            document.getElementById('modalPaymentDate').textContent = date;
            document.getElementById('modalPaymentAmount').textContent = amount + ' Kƒç';
            document.getElementById('modalPaymentAccount').textContent = account;

            // Set editable fields
            document.getElementById('editVS').value = vs || '';
            document.getElementById('editMessage').value = message || '';
            document.getElementById('editComment').value = comment || '';
            document.getElementById('staffComment').value = '';

            // Reset assign type
            document.querySelectorAll('input[name="assignType"]').forEach(r => r.checked = false);
            document.getElementById('userAssignSection').style.display = 'none';
            document.getElementById('projectAssignSection').style.display = 'none';
            document.getElementById('dismissSection').style.display = 'none';
            document.getElementById('dismissReason').value = '';

            // Reset all label styles
            document.querySelectorAll('input[name="assignType"]').forEach(radio => {
                const label = radio.closest('label');
                if (label) {
                    label.style.borderColor = '#e5e7eb';
                    label.style.background = radio.value === 'dismiss' ? '#fef2f2' : 'white';
                }
            });

            // Reset user search
            document.getElementById('userSearch').value = '';
            document.getElementById('userList').innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280; font-size: 13px;">Zadejte text pro vyhled√°n√≠ u≈æivatele</div>';

            // Load projects for dropdown
            loadProjects();

            // Show modal
            document.getElementById('assignmentModal').style.display = 'block';
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'none';
        }

        function handleAssignTypeChange(type) {
            // Hide all sections first
            document.getElementById('userAssignSection').style.display = 'none';
            document.getElementById('projectAssignSection').style.display = 'none';
            document.getElementById('dismissSection').style.display = 'none';

            // Show relevant section
            if (type === 'user') {
                document.getElementById('userAssignSection').style.display = 'block';
                selectedProjectId = null;
            } else if (type === 'project') {
                document.getElementById('projectAssignSection').style.display = 'block';
                selectedUserId = null;
            } else if (type === 'dismiss') {
                document.getElementById('dismissSection').style.display = 'block';
                selectedUserId = null;
                selectedProjectId = null;
            } else if (type === 'unmatched') {
                selectedUserId = null;
                selectedProjectId = null;
            }

            // Update button highlighting
            const labels = document.querySelectorAll('input[name="assignType"]');
            labels.forEach(radio => {
                const label = radio.closest('label');
                if (label) {
                    if (radio.checked) {
                        label.style.borderColor = '#2196F3';
                        label.style.background = type === 'dismiss' ? '#fee2e2' : '#eff6ff';
                    } else {
                        label.style.borderColor = '#e5e7eb';
                        label.style.background = radio.value === 'dismiss' ? '#fef2f2' : 'white';
                    }
                }
            });
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/admin/projects');
                const data = await response.json();

                const select = document.getElementById('projectSelect');
                if (data.projects && data.projects.length > 0) {
                    select.innerHTML = '<option value="">-- Vyberte projekt --</option>';
                    data.projects.forEach(project => {
                        select.innerHTML += `<option value="${project.id}">${project.name} (VS: ${project.payments_id || 'N/A'})</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">≈Ω√°dn√© projekty (vytvo≈ôte v /admin/projects)</option>';
                }
            } catch (error) {
                document.getElementById('projectSelect').innerHTML = '<option value="">Chyba naƒç√≠t√°n√≠ projekt≈Ø</option>';
            }
        }

        async function searchUsers() {
            const query = document.getElementById('userSearch').value;
            if (query.length < 2) {
                document.getElementById('userList').innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280; font-size: 13px;">Zadejte alespo≈à 2 znaky</div>';
                return;
            }

            try {
                const response = await fetch(`/api/admin/users?search=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.users && data.users.length > 0) {
                    let html = '<div style="padding: 10px;">';
                    data.users.forEach(user => {
                        const displayName = user.realname || user.username || user.email;
                        const escapedName = displayName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const escapedEmail = user.email.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        html += `
                            <div class="user-item" onclick="selectUser(${user.id}, '${escapedName}', '${escapedEmail}', '${user.payments_id || ''}', this)" style="padding: 10px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.15s;">
                                <div style="font-weight: 600;">${displayName}</div>
                                <div style="font-size: 13px; color: #6b7280;">${user.email}${user.payments_id ? ' | VS: ' + user.payments_id : ''}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('userList').innerHTML = html;
                } else {
                    document.getElementById('userList').innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280; font-size: 13px;">≈Ω√°dn√≠ u≈æivatel√© nenalezeni</div>';
                }
            } catch (error) {
                document.getElementById('userList').innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444; font-size: 13px;">Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatel≈Ø</div>';
            }
        }

        function selectUser(userId, displayName, email, paymentsId, element) {
            selectedUserId = userId;

            // Highlight selected user
            document.querySelectorAll('.user-item').forEach(item => {
                item.style.background = 'transparent';
                item.style.borderLeft = 'none';
            });

            // Find and highlight the clicked element
            const userItem = element ? element.closest('.user-item') : null;
            if (userItem) {
                userItem.style.background = '#eff6ff';
                userItem.style.borderLeft = '3px solid #2196F3';
            }

            // Show selected user info
            document.getElementById('userSearch').value = displayName + ' (' + email + ')';
        }

        async function confirmAssignment() {
            const assignType = document.querySelector('input[name="assignType"]:checked');
            const vs = document.getElementById('editVS').value.trim();
            const message = document.getElementById('editMessage').value.trim();
            const comment = document.getElementById('editComment').value.trim();
            const staffComment = document.getElementById('staffComment').value.trim();

            // Handle dismiss separately
            if (assignType && assignType.value === 'dismiss') {
                const dismissReason = document.getElementById('dismissReason').value.trim();
                try {
                    const response = await fetch('/api/admin/payments/dismiss', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            payment_id: currentPaymentId,
                            reason: dismissReason || staffComment || 'Bez ud√°n√≠ d≈Øvodu'
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Platba byla oznaƒçena jako vy≈ô√≠zen√°!');
                        location.reload();
                    } else {
                        alert('Chyba: ' + (data.error || 'Nepoda≈ôilo se oznaƒçit platbu'));
                    }
                } catch (error) {
                    alert('Chyba: ' + error);
                }
                return;
            }

            // Validate based on assignment type
            if (assignType && assignType.value === 'user') {
                if (!selectedUserId) {
                    alert('Pros√≠m vyberte u≈æivatele');
                    return;
                }
            } else if (assignType && assignType.value === 'project') {
                selectedProjectId = parseInt(document.getElementById('projectSelect').value);
                if (!selectedProjectId) {
                    alert('Pros√≠m vyberte projekt');
                    return;
                }
            }

            const payload = {
                payment_id: currentPaymentId,
                vs: vs,
                message: message,
                comment: comment,
                staff_comment: staffComment,
                assign_type: assignType ? assignType.value : 'unmatched',
                user_id: selectedUserId,
                project_id: selectedProjectId
            };

            try {
                const response = await fetch('/api/admin/payments/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    alert('Platba byla √∫spƒõ≈°nƒõ upravena!');
                    location.reload();
                } else {
                    alert('Chyba: ' + (data.error || 'Nepoda≈ôilo se upravit platbu'));
                }
            } catch (error) {
                alert('Chyba p≈ôi √∫pravƒõ platby: ' + error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('assignmentModal');
            if (event.target == modal) {
                closeAssignmentModal();
            }
        }

        // Handle project select change
        document.addEventListener('DOMContentLoaded', function() {
            const projectSelect = document.getElementById('projectSelect');
            if (projectSelect) {
                projectSelect.addEventListener('change', function() {
                    selectedProjectId = this.value ? parseInt(this.value) : null;
                });
            }
        });

        // Undismiss (restore) a payment from archive
        async function undismissPayment(paymentId) {
            if (!confirm('O≈æivit tuto platbu? Vr√°t√≠ se zpƒõt do seznamu nesp√°rovan√Ωch plateb.')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/payments/undismiss', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        payment_id: paymentId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Platba byla o≈æivena!');
                    location.reload();
                } else {
                    alert('Chyba: ' + (data.error || 'Nepoda≈ôilo se o≈æivit platbu'));
                }
            } catch (error) {
                alert('Chyba: ' + error);
            }
        }
    </script>
{{ end }}
