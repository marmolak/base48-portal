{{ define "content" }}
<style>
/* Page-specific styles for admin_projects ‚Äî shared styles are in /static/css/admin.css */

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        margin-bottom: 30px;
    }

    h1 {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .subtitle {
        color: #666;
        font-size: 14px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    th, td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    tr:last-child td {
        border-bottom: none;
    }

    tr:hover {
        background-color: #f9fafb;
    }

    .vs {
        font-family: 'Courier New', monospace;
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: 600;
    }

    .vs-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-family: 'Courier New', monospace;
        background: #dbeafe;
        color: #1e40af;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 4px;
        margin-bottom: 2px;
    }

    .vs-tag .remove-vs {
        cursor: pointer;
        color: #6b7280;
        font-size: 14px;
        margin-left: 2px;
        line-height: 1;
    }

    .vs-tag .remove-vs:hover {
        color: #ef4444;
    }

    .vs-tag.primary {
        background: #d1fae5;
        color: #065f46;
    }

    .add-vs-btn {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        background: #f3f4f6;
        color: #6b7280;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        cursor: pointer;
        border: 1px dashed #d1d5db;
    }

    .add-vs-btn:hover {
        background: #e5e7eb;
        color: #374151;
    }

    details {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    summary {
        padding: 20px;
        cursor: pointer;
        font-weight: 600;
        list-style: none;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    summary::-webkit-details-marker {
        display: none;
    }

    summary:hover {
        background: #f9fafb;
    }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .project-info {
        flex: 1;
    }

    .project-title {
        font-size: 18px;
        color: #111827;
        margin-bottom: 5px;
    }

    .project-meta {
        font-size: 14px;
        color: #6b7280;
        font-weight: normal;
    }

    .project-balance {
        font-size: 24px;
        font-weight: 700;
        color: #059669;
        margin-right: 20px;
    }

    .payments-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px;
    }

    .payments-table th {
        background: #f9fafb;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }

    .payments-table td {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
    }

    .payments-table tr:hover {
        background: #f9fafb;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #374151;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
    }

    .form-group input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
    }

    .form-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
</style>

<div class="container">
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üèóÔ∏è Spr√°va projekt≈Ø a fundraising</h1>
                <p class="subtitle">Projekty se speci√°ln√≠m VS pro sbƒõr p≈ô√≠spƒõvk≈Ø</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal()">+ Nov√Ω projekt</button>
        </div>
    </div>

    <div id="projectsList">
        <div style="text-align: center; padding: 40px; color: #6b7280;">
            Naƒç√≠t√°n√≠ projekt≈Ø...
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div id="createModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeCreateModal()">&times;</span>
        <h2>Vytvo≈ôit nov√Ω projekt</h2>

        <form id="createProjectForm" onsubmit="createProject(event)">
            <div class="form-group">
                <label>N√°zev projektu *</label>
                <input type="text" id="projectName" required placeholder="nap≈ô. Energie 2024">
            </div>

            <div class="form-group">
                <label>Variabiln√≠ symbol (VS) *</label>
                <input type="text" id="projectVS" required placeholder="nap≈ô. 2024" pattern="[0-9]+" title="Pouze ƒç√≠sla">
            </div>

            <div class="form-group">
                <label>Popis</label>
                <textarea id="projectDescription" rows="3" placeholder="Popis projektu, pro co sb√≠r√°me pen√≠ze..."></textarea>
            </div>

            <div class="form-actions">
                <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">Zru≈°it</button>
                <button type="submit" class="btn btn-primary">Vytvo≈ôit projekt</button>
            </div>
        </form>
    </div>
</div>

<script>
async function loadProjects() {
    try {
        const response = await fetch('/api/admin/projects');
        const data = await response.json();

        const container = document.getElementById('projectsList');

        if (data.projects && data.projects.length > 0) {
            container.innerHTML = '';
            data.projects.forEach(project => {
                const balance = project.total_amount || 0;

                // Build VS tags HTML
                let vsTagsHtml = '';
                if (project.vs_list && project.vs_list.length > 0) {
                    project.vs_list.forEach((vsItem, index) => {
                        const isPrimary = index === 0;
                        const noteTitle = vsItem.note ? ` title="${vsItem.note}"` : '';
                        vsTagsHtml += `
                            <span class="vs-tag ${isPrimary ? 'primary' : ''}"${noteTitle}>
                                ${vsItem.vs}
                                <span class="remove-vs" onclick="event.stopPropagation(); removeVS(${project.id}, '${vsItem.vs}')" title="Odebrat VS">√ó</span>
                            </span>
                        `;
                    });
                } else {
                    vsTagsHtml = '<span style="color: #9ca3af;">≈æ√°dn√© VS</span>';
                }

                const projectSection = document.createElement('details');
                projectSection.innerHTML = `
                    <summary>
                        <div class="project-header">
                            <div class="project-info">
                                <div class="project-title">${project.name}</div>
                                <div class="project-meta">
                                    VS: ${vsTagsHtml}
                                    <span class="add-vs-btn" onclick="event.stopPropagation(); addVSPrompt(${project.id})" title="P≈ôidat dal≈°√≠ VS">+ VS</span>
                                    ${project.description ? '<br><span style="color: #9ca3af;">' + project.description + '</span>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="project-balance">
                                    ${balance.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Kƒç
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteProject(${project.id}, '${project.name.replace(/'/g, "\\'")}')">
                                    Smazat
                                </button>
                            </div>
                        </div>
                    </summary>
                    <div id="payments-${project.id}" style="padding: 20px; border-top: 1px solid #e5e7eb;">
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            Naƒç√≠t√°n√≠ plateb...
                        </div>
                    </div>
                `;

                // Load payments when details is opened
                projectSection.addEventListener('toggle', function() {
                    if (this.open) {
                        loadProjectPayments(project.id);
                    }
                });

                container.appendChild(projectSection);
            });
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    ≈Ω√°dn√© projekty. Vytvo≈ôte prvn√≠ projekt pomoc√≠ tlaƒç√≠tka "+ Nov√Ω projekt".
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading projects:', error);
        document.getElementById('projectsList').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                Chyba p≈ôi naƒç√≠t√°n√≠ projekt≈Ø: ${error.message}
            </div>
        `;
    }
}

async function loadProjectPayments(projectId) {
    try {
        const response = await fetch(`/api/admin/projects/payments?project_id=${projectId}`);
        const data = await response.json();

        const container = document.getElementById(`payments-${projectId}`);

        if (data.payments && data.payments.length > 0) {
            let html = `
                <table class="payments-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Datum</th>
                            <th>ƒå√°stka</th>
                            <th>Odes√≠latel</th>
                            <th>VS</th>
                            <th>Koment√°≈ô</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.payments.forEach(payment => {
                html += `
                    <tr>
                        <td>#${payment.id}</td>
                        <td>${payment.date}</td>
                        <td style="color: #059669; font-weight: 600;">+${payment.amount} Kƒç</td>
                        <td>${payment.remote_account}</td>
                        <td><span class="vs">${payment.identification || '-'}</span></td>
                        <td style="font-size: 13px; color: #6b7280;">${payment.comment || '-'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    ≈Ω√°dn√© platby pro tento projekt.
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading project payments:', error);
        document.getElementById(`payments-${projectId}`).innerHTML = `
            <div style="text-align: center; padding: 20px; color: #ef4444;">
                Chyba p≈ôi naƒç√≠t√°n√≠ plateb: ${error.message}
            </div>
        `;
    }
}

async function deleteProject(projectId, projectName) {
    if (!confirm(`Opravdu chcete smazat projekt "${projectName}"? Tato akce je nevratn√°!`)) {
        return;
    }

    try {
        const response = await fetch('/api/admin/projects', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ project_id: projectId })
        });

        const data = await response.json();

        if (data.success) {
            alert('Projekt byl √∫spƒõ≈°nƒõ smaz√°n!');
            loadProjects();
        } else {
            alert('Chyba: ' + (data.error || 'Nepoda≈ôilo se smazat projekt'));
        }
    } catch (error) {
        alert('Chyba p≈ôi maz√°n√≠ projektu: ' + error);
    }
}

function openCreateModal() {
    document.getElementById('createModal').style.display = 'block';
}

function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createProjectForm').reset();
}

async function createProject(event) {
    event.preventDefault();

    const payload = {
        name: document.getElementById('projectName').value,
        payments_id: document.getElementById('projectVS').value,
        description: document.getElementById('projectDescription').value
    };

    try {
        const response = await fetch('/api/admin/projects', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
            alert('Projekt byl √∫spƒõ≈°nƒõ vytvo≈ôen!');
            closeCreateModal();
            loadProjects();
        } else {
            alert('Chyba: ' + (data.error || 'Nepoda≈ôilo se vytvo≈ôit projekt'));
        }
    } catch (error) {
        alert('Chyba p≈ôi vytv√°≈ôen√≠ projektu: ' + error);
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('createModal');
    if (event.target == modal) {
        closeCreateModal();
    }
}

// Add VS to project
async function addVSPrompt(projectId) {
    const vs = prompt('Zadejte nov√Ω variabiln√≠ symbol pro projekt:');
    if (!vs) return;

    // Validate VS is numeric
    if (!/^\d+$/.test(vs)) {
        alert('Variabiln√≠ symbol mus√≠ obsahovat pouze ƒç√≠sla!');
        return;
    }

    const note = prompt('Pozn√°mka (voliteln√©, nap≈ô. "p≈ôeklep od XY"):') || '';

    try {
        const response = await fetch('/api/admin/projects/vs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                vs: vs,
                note: note
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('VS bylo p≈ôid√°no!');
            loadProjects();
        } else {
            alert('Chyba: ' + (data.error || 'Nepoda≈ôilo se p≈ôidat VS'));
        }
    } catch (error) {
        alert('Chyba: ' + error);
    }
}

// Remove VS from project
async function removeVS(projectId, vs) {
    if (!confirm(`Opravdu chcete odebrat VS "${vs}" z projektu?`)) {
        return;
    }

    try {
        const response = await fetch('/api/admin/projects/vs', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                vs: vs
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('VS bylo odebr√°no!');
            loadProjects();
        } else {
            alert('Chyba: ' + (data.error || 'Nepoda≈ôilo se odebrat VS'));
        }
    } catch (error) {
        alert('Chyba: ' + error);
    }
}

// Load projects on page load
document.addEventListener('DOMContentLoaded', loadProjects);
</script>
{{ end }}
